<%
  component = Component.find(component_id)
  editable_fields = component.editable_fields
  field_types = component.field_types

  # Get user's customisations for this component and theme_page
  user = User.find(user_id)
  customisations = user.website&.customisations&.dig("customisations") || []

  # Create a hash of field_name => field_value for quick lookup
  custom_values = {}
  customisations.each do |customisation|
    if customisation["component_id"] == component.id.to_s &&
       customisation["theme_page_id"] == theme_page_id.to_s && customisation['component_page_id'] == component_page_id
      custom_values[customisation["field_name"]] = customisation["field_value"]
    end
  end
%>

<%= form_with url: manage_website_editor_website_editor_sidebar_editor_fields_save_path,
              remote: true,
              method: :post,
              multipart: true,
              local: false,
              class: 'p-4 space-y-3' do |form| %>

  <%= form.hidden_field :component_id, value: component.id %>
  <%= form.hidden_field :theme_page_id, value: theme_page_id %>
  <%= form.hidden_field :user_id, value: user_id %>
  <%= form.hidden_field :component_page_id, value: component_page_id %>

  <div class="sidebar-form-fields">
    <% component.field_types.each do |name, type| %>

      <% unless name.include? "global" %>
        <% if name.include?("background") %>

          <div class="sidebar-field">
            <%= form.label name, name.to_s.humanize, class: 'nata-sans text-sm font-semibold' %>
            <div>
              <%
                # Helper to get default value - check both flat and nested structure
                default_value = custom_values[name] ||
                                component.editable_fields[name] ||
                                component.editable_fields.dig('background', name)
              %>

              <% if type == 'text' %>
                <% if name.include?('opacity') %>
                  <%= form.number_field name,
                                        value: default_value,
                                        placeholder: "Enter your #{name}",
                                        min: "0",
                                        max: "1",
                                        step: "0.1",
                                        class: "nata-sans text-sm font-normal w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 " + 'field_' + theme_page_id.to_s + '_' + component_page_id.to_s + '_' + name.to_s,
                                        data: {
                                          field_type: 'opacity',
                                          theme_page_id: theme_page_id,
                                          component_page_id: component_page_id,
                                          field_name: name
                                        } %>
                <% else %>
                  <%= form.text_field name,
                                      value: default_value,
                                      placeholder: "Enter your #{name}",
                                      class: "nata-sans text-sm font-normal w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 " + 'field_' + theme_page_id.to_s + '_' + component_page_id.to_s + '_' + name.to_s %>
                <% end %>
              <% elsif type == 'textarea' %>
                <div class="wysiwyg-container" data-controller="wysiwyg">
                  <div data-wysiwyg-target="editor" class="border border-gray-300 rounded-md"></div>
                  <%= form.hidden_field name,
                                        value: default_value,
                                        data: { wysiwyg_target: "input" },
                                        class: 'field_' + theme_page_id.to_s + '_' + component_page_id.to_s + '_' + name.to_s %>
                </div>
              <% elsif type == 'color' %>
                <%= form.color_field name,
                                     value: default_value,
                                     class: "w-full h-10 border border-gray-300 rounded cursor-pointer " + 'field_' + theme_page_id.to_s + '_' + component_page_id.to_s + '_' + name.to_s,
                                     data: {
                                       field_type: 'color',
                                       theme_page_id: theme_page_id,
                                       component_page_id: component_page_id,
                                       field_name: name
                                     } %>
              <% elsif type == 'image' %>

                <% current_image = default_value %>


                <div class="image-field">
                  <% if current_image %>
                    <div class="current-image mb-3">
                      <%= image_tag current_image, class: "w-32 h-32 object-cover rounded border" %>
                      <p class="text-sm text-gray-600 mt-1">Current image</p>
                    </div>
                  <% end %>

                  <div class="file-input">
                    <%= form.file_field name,
                                        accept: "image/*",
                                        class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 " + 'field_' + theme_page_id.to_s + '_' + component_page_id.to_s + '_' + name.to_s,
                                        data: {
                                          field_type: 'image',
                                          theme_page_id: theme_page_id,
                                          component_page_id: component_page_id,
                                          field_name: name
                                        } %>
                  </div>

                  <% if current_image %>
                    <div class="remove-option mt-2">
                      <%= form.check_box "remove_#{name}", {}, "1", "" %>
                      <%= form.label "remove_#{name}", "Remove current image", class: "ml-2 text-sm text-gray-600" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>

    <% end %>
  </div>

  <div>
    <%= form.submit "Save Changes", class: "btn btn-primary" %>
  </div>
<% end %>