<%
  component = Component.find(component_id)
  editable_fields = component.editable_fields
  field_types = component.field_types

  # Get user's customisations for this component and theme_page
  user = User.find(user_id)
  customisations = user.website&.customisations&.dig("customisations") || []

  # Create a hash of field_name => field_value for quick lookup
  custom_values = {}
  customisations.each do |customisation|
    if customisation["component_id"] == component.id.to_s &&
       customisation["theme_page_id"] == theme_page_id.to_s && customisation['component_page_id'] == component_page_id
      custom_values[customisation["field_name"]] = customisation["field_value"]
    end
  end
%>

<%= form_with url: manage_website_editor_website_editor_sidebar_editor_fields_save_path,
              remote: true,
              method: :post,
              class: 'p-4 space-y-3' do |form| %>

  <%= form.hidden_field :component_id, value: component.id %>
  <%= form.hidden_field :theme_page_id, value: theme_page_id %>
  <%= form.hidden_field :user_id, value: user_id %>
  <%= form.hidden_field :component_page_id, value: component_page_id %>

  <% component.field_types.each do |name, type| %>

    <div class="sidebar-field">
      <%= form.label name, name.to_s.humanize, class: 'nata-sans text-sm font-semibold' %>
      <div>
        <% if type == 'text' %>
          <%= form.text_field name,
                              value: custom_values[name] || component.editable_fields[name],
                              placeholder: "Enter your #{name}",
                              class: "nata-sans text-sm font-normal w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 " + 'field_' + theme_page_id.to_s + '_' + component_page_id.to_s + '_' + name.to_s %>
        <% elsif type == 'textarea' %>
          <%= form.textarea name,
                            value: custom_values[name] || component.editable_fields[name],
                            placeholder: "Enter your #{name}",
                            class: "nata-sans text-sm font-normal w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 " + 'field_' + theme_page_id.to_s + '_' + component_page_id.to_s + '_' + name.to_s %>
        <% elsif type == 'image' %>
          <% field_id = 'field_' + theme_page_id.to_s + '_' + component_page_id.to_s + '_' + name.to_s %>
          <% current_image = custom_values[name] || component.editable_fields[name] %>

          <div class="image-upload-container" data-field-id="<%= field_id %>">
            <% if current_image %>
              <!-- Current Image Display -->
              <div class="current-image-display group relative overflow-hidden rounded-xl border-2 border-gray-200 bg-white shadow-lg transition-all duration-300 hover:shadow-xl">
                <div class="aspect-video relative overflow-hidden bg-gray-50">
                  <%= image_tag current_image,
                                class: "w-full h-full object-cover transition-transform duration-300 group-hover:scale-105",
                                id: "preview-#{field_id}" %>

                  <!-- Overlay on hover -->
                  <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center">
                    <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <div class="flex space-x-3">
                        <button type="button"
                                class="change-image-btn bg-white text-gray-700 px-4 py-2 rounded-lg font-medium shadow-lg hover:bg-gray-50 transition-colors flex items-center space-x-2"
                                onclick="ImageUploadHandler.triggerFileInput('<%= field_id %>')">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                          </svg>
                          <span>Change</span>
                        </button>
                        <button type="button"
                                class="remove-image-btn bg-red-500 text-white px-4 py-2 rounded-lg font-medium shadow-lg hover:bg-red-600 transition-colors flex items-center space-x-2"
                                onclick="ImageUploadHandler.removeImage('<%= field_id %>')">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                          </svg>
                          <span>Remove</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Image info -->
                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                      <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                      <span class="text-sm font-medium text-gray-700">Current Image</span>
                    </div>
                    <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded-full">Ready</span>
                  </div>
                </div>
              </div>
            <% else %>
              <!-- Upload New Image -->
              <div class="upload-drop-zone border-3 border-dashed border-gray-300 rounded-xl p-8 text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50/30 cursor-pointer group"
                   onclick="ImageUploadHandler.triggerFileInput('<%= field_id %>')"
                   ondrop="ImageUploadHandler.handleDrop(event, '<%= field_id %>')"
                   ondragover="ImageUploadHandler.handleDragOver(event)"
                   ondragleave="ImageUploadHandler.handleDragLeave(event)">

                <div class="upload-content">
                  <!-- Upload Icon -->
                  <div class="mx-auto w-16 h-16 bg-gradient-to-br from-blue-100 to-indigo-200 rounded-full flex items-center justify-center mb-4 group-hover:from-blue-200 group-hover:to-indigo-300 transition-all duration-300">
                    <svg class="w-8 h-8 text-blue-600 group-hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                  </div>

                  <!-- Upload Text -->
                  <h3 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-900 transition-colors">
                    Drop your image here
                  </h3>
                  <p class="text-gray-600 mb-4 group-hover:text-gray-700 transition-colors">
                    or <span class="text-blue-600 font-medium">browse</span> to choose a file
                  </p>

                  <!-- Supported formats -->
                  <div class="flex items-center justify-center space-x-4 text-xs text-gray-500">
                    <span class="bg-gray-100 px-2 py-1 rounded">JPG</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">PNG</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">GIF</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">WEBP</span>
                  </div>
                </div>
              </div>
            <% end %>

            <!-- Hidden file input -->
            <%= form.file_field name,
                                class: "hidden " + field_id,
                                id: field_id,
                                accept: "image/*",
                                onchange: "ImageUploadHandler.handleFileSelect(event, '#{field_id}')" %>
          </div>
        <% end %>
      </div>



    </div>
  <% end %>

  <div>
    <%= form.submit "Save Changes", class: "btn btn-primary" %>
  </div>
<% end %>