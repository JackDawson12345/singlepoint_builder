<!-- app/views/manage/website/products/_form.html.erb -->
<%= form_with scope: :product, url: form_url, method: form_method, local: true, multipart: true do |form| %>

  <div class="flex gap-5">
    <div class="w-3/4 space-y-5">
      <!-- Basic Product Info -->
      <div class="py-4 px-6 bg-gray-50 rounded-lg flex flex-col gap-5">
        <div>
          <%= form.label :name, 'Title', class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.text_field :name,
                                value: @product ? @product.dig('data', 'name') : '',
                                required: true,
                                class: "w-full p-2 border rounded text-sm nata-sans",
                                placeholder: "Short sleeve t-shirt"
            %>
          </div>
        </div>

        <div>
          <%= form.label :description, class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.text_area :description,
                               value: @product ? @product.dig('data', 'description') : '',
                               rows: 3,
                               class: "w-full p-2 border rounded text-sm nata-sans" %>
          </div>
        </div>

        <!-- Image Upload Section -->
        <div>
          <%= form.label :images, "Media", class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-2 p-6 border border-dashed rounded-lg flex flex-col items-center justify-center">
            <%= form.file_field :images,
                                multiple: true,
                                accept: "image/*",
                                class: "w-auto text-sm nata-sans block text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" %>
            <p class="mt-2 text-sm text-gray-500 text-sm nata-sans">Upload multiple images for your product. PNG, JPG, GIF up to 10MB each.</p>
          </div>
        </div>

        <!-- Display existing images if editing -->
        <% if @product && @product_images&.any? %>
          <div>
            <label class="block text-sm font-medium text-gray-700 nata-sans">Current Images</label>
            <div class="mt-2 grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">
              <% @product_images.each_with_index do |image_url, index| %>
                <div class="relative">
                  <%= image_tag image_url, class: "h-24 w-24 rounded-lg object-cover" %>
                  <%= link_to "×",
                              remove_image_manage_website_shop_product_path(@product['id'], image_index: index),
                              method: :delete,
                              data: { confirm: "Remove this image?" },
                              class: "absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <div>
          <%= form.label :categories, class: "block text-sm font-medium text-gray-700 nata-sans" %>

          <!-- Hidden input to store selected category IDs -->
          <%= form.hidden_field :categories,
                                value: (selected_categories(@product).join(',') if selected_categories(@product).any?),
                                data: { 'categories-hidden': true } %>

          <!-- Custom dropdown -->
          <div class="relative mt-1" data-category-dropdown>
            <button type="button"
                    class="w-full p-2 border rounded text-sm nata-sans bg-white text-left flex justify-between items-center"
                    data-category-trigger>
              <span data-category-placeholder>Select categories...</span>
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>

            <!-- Dropdown menu -->
            <div class="absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg hidden" data-category-menu>
              <div class="max-h-60 overflow-y-auto">
                <%
                  # Get current selected categories as an array
                  current_categories = selected_categories(@product)

                  # Get all product categories
                  all_categories = []
                  if current_user.website&.categories&.dig('products')
                    current_user.website.categories['products'].each do |id, category|
                      all_categories << {
                        id: id,
                        name: category['name'],
                        parent_category: category['parent_category'],
                        selected: current_categories.include?(id)
                      }
                    end
                  end

                  # Sort categories to show parent categories first, then children
                  def sort_categories_hierarchically(categories)
                    # First get all top-level categories (no parent)
                    top_level = categories.select { |cat| cat[:parent_category].blank? }
                    # Then get categories with parents
                    with_parents = categories.select { |cat| cat[:parent_category].present? }

                    result = []

                    # Add top-level categories and their children recursively
                    top_level.each do |parent_cat|
                      result << parent_cat
                      # Find and add children
                      add_children_recursively(result, with_parents, parent_cat[:id], 1)
                    end

                    # Add any remaining categories that might have invalid parent references
                    remaining = with_parents.select { |cat| !result.include?(cat) }
                    result.concat(remaining)

                    result
                  end

                  def add_children_recursively(result, remaining_categories, parent_id, level)
                    children = remaining_categories.select { |cat| cat[:parent_category] == parent_id }
                    children.each do |child|
                      child[:level] = level
                      result << child
                      remaining_categories.delete(child)
                      # Recursively add grandchildren
                      add_children_recursively(result, remaining_categories, child[:id], level + 1)
                    end
                  end

                  sorted_categories = sort_categories_hierarchically(all_categories)
                %>

                <% if sorted_categories.empty? %>
                  <div class="p-3 text-gray-500 text-sm">No categories available</div>
                <% else %>
                  <div class="p-2">
                    <% sorted_categories.each do |category| %>
                      <% indent_class = category[:level] ? "ml-#{category[:level] * 4}" : "" %>
                      <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer <%= indent_class %>">
                        <input type="checkbox"
                               value="<%= category[:id] %>"
                               data-category-name="<%= category[:name] %>"
                               data-category-checkbox
                               <%= 'checked' if category[:selected] %>
                               class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <div class="flex-1">
                          <div class="text-sm font-medium text-gray-900">
                            <%= '└─ ' if category[:level] && category[:level] > 0 %>
                            <%= category[:name] %>
                          </div>
                        </div>
                      </label>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <p class="mt-1 text-xs text-gray-500">Select one or more categories for this product</p>
          <div data-category-preview class="mt-2"></div>
        </div>
      </div>

      <!-- Pricing Section -->
      <div class="py-4 px-6 bg-gray-50 rounded-lg flex flex-col gap-5">
        <h3 class="text-lg font-medium text-gray-900 nata-sans">Pricing</h3>
        <div class="flex gap-5">
          <div class="w-1/3">
            <%= form.label :price, "Price", class: "block text-sm font-medium text-gray-700 nata-sans" %>
            <div class="mt-1">
              <%= form.number_field :price,
                                    value: @product ? @product.dig('price', 'price') : '',
                                    step: 0.01,
                                    required: true,
                                    class: "w-full p-2 border rounded text-sm nata-sans" %>
            </div>
          </div>
          <div class="w-1/3">
            <%= form.label :sale_price, "Sale Price", class: "block text-sm font-medium text-gray-700 nata-sans" %>
            <div class="mt-1">
              <%= form.number_field :sale_price,
                                    value: @product ? @product.dig('price', 'sale_price') : '',
                                    step: 0.01,
                                    class: "w-full p-2 border rounded text-sm nata-sans" %>
            </div>
          </div>
        </div>
        <div class="w-1/3">
          <div>
            <%= form.label :cost_per_item, "Cost per Item", class: "block text-sm font-medium text-gray-700 nata-sans" %>
            <div class="mt-1">
              <%= form.number_field :cost_per_item,
                                    value: @product ? @product.dig('price', 'cost_per_item') : '',
                                    step: 0.01,
                                    class: "w-full p-2 border rounded text-sm nata-sans" %>
            </div>
          </div>
        </div>
      </div>

      <!-- Inventory Section -->
      <div class="py-4 px-6 bg-gray-50 rounded-lg flex flex-col gap-5">
        <h3 class="text-lg font-medium text-gray-900 nata-sans">Inventory</h3>

        <div class="flex items-center">
          <%= form.check_box :track_quantity,
                             checked: @product ? @product.dig('inventory', 'track_quantity') : true,
                             class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded",
                             id: "track_quantity_checkbox" %>
          <%= form.label :track_quantity, "Track quantity", class: "ml-2 block text-sm text-gray-900 nata-sans" %>
        </div>

        <div id="quantity_field">
          <%= form.label :quantity, "Quantity", class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.number_field :quantity,
                                  value: @product ? @product.dig('inventory', 'quantity') : 0,
                                  min: 0,
                                  class: "w-full p-2 border rounded text-sm nata-sans" %>
          </div>
        </div>

        <div class="flex items-center" id="sell_out_of_stock_field">
          <%= form.check_box :sell_out_of_stock,
                             checked: @product ? @product.dig('inventory', 'sell_out_of_stock') : false,
                             class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
          <%= form.label :sell_out_of_stock, "Continue selling when out of stock", class: "ml-2 block text-sm text-gray-900 nata-sans" %>
        </div>

        <div class="flex items-center">
          <%= form.check_box :has_sku_or_barcode,
                             checked: @product ? @product.dig('inventory', 'has_sku_or_barcode') : true,
                             class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded",
                             id: "has_sku_or_barcode_checkbox" %>
          <%= form.label :has_sku_or_barcode, "This product has a SKU or barcode", class: "ml-2 block text-sm text-gray-900 nata-sans" %>
        </div>

        <div class="flex gap-5" id="sku_barcode_fields">
          <div class="w-1/2">
            <%= form.label :sku, "SKU (Stock Keeping Unit)", class: "block text-sm font-medium text-gray-700 nata-sans" %>
            <div class="mt-1">
              <%= form.text_field :sku,
                                  value: @product ? @product.dig('inventory', 'sku') : '',
                                  class: "w-full p-2 border rounded text-sm nata-sans" %>
            </div>
          </div>
          <div  class="w-1/2">
            <%= form.label :barcode, "Barcode (ISBN, UPC, GTIN, etc.)", class: "block text-sm font-medium text-gray-700 nata-sans" %>
            <div class="mt-1">
              <%= form.text_field :barcode,
                                  value: @product ? @product.dig('inventory', 'barcode') : '',
                                  class: "w-full p-2 border rounded text-sm nata-sans" %>
            </div>
          </div>
        </div>
      </div>

      <!-- Shipping Section -->
      <div class="py-4 px-6 bg-gray-50 rounded-lg flex flex-col gap-5">
        <h3 class="text-lg font-medium text-gray-900 nata-sans">Shipping</h3>

        <div class="flex items-center">
          <%= form.check_box :physical_product,
                             checked: @product ? @product.dig('shipping', 'physical_product') : true,
                             class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded",
                             id: "physical_product_checkbox" %>
          <%= form.label :physical_product, "This is a physical product", class: "ml-2 block text-sm text-gray-900 nata-sans" %>
        </div>

        <div id="physical_product_fields">
          <div>
            <%= form.label :weight, "Weight", class: "block text-sm font-medium text-gray-700 nata-sans" %>
            <div class="mt-1">
              <%= form.text_field :weight,
                                  value: @product ? @product.dig('shipping', 'weight') : '',
                                  placeholder: "e.g. 1.2kg or 8oz",
                                  class: "w-full p-2 border rounded text-sm nata-sans" %>
            </div>
          </div>

          <div class="flex gap-5 mt-5">
            <div class="w-1/3">
              <%= form.label :width, "Width", class: "block text-sm font-medium text-gray-700 nata-sans" %>
              <div class="mt-1">
                <%= form.text_field :width,
                                    value: @product ? @product.dig('shipping', 'sizes', 'width') : '',
                                    placeholder: "e.g. 40cm",
                                    class: "w-full p-2 border rounded text-sm nata-sans" %>
              </div>
            </div>
            <div class="w-1/3">
              <%= form.label :height, "Height", class: "block text-sm font-medium text-gray-700 nata-sans" %>
              <div class="mt-1">
                <%= form.text_field :height,
                                    value: @product ? @product.dig('shipping', 'sizes', 'height') : '',
                                    placeholder: "e.g. 40cm",
                                    class: "w-full p-2 border rounded text-sm nata-sans" %>
              </div>
            </div>
            <div class="w-1/3">
              <%= form.label :depth, "Depth", class: "block text-sm font-medium text-gray-700 nata-sans" %>
              <div class="mt-1">
                <%= form.text_field :depth,
                                    value: @product ? @product.dig('shipping', 'sizes', 'depth') : '',
                                    placeholder: "e.g. 40cm",
                                    class: "w-full p-2 border rounded text-sm nata-sans" %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Variants Section -->
      <div class="py-4 px-6 bg-gray-50 rounded-lg flex flex-col gap-5">
        <h3 class="text-lg font-medium text-gray-900 nata-sans">Variants</h3>
        <p class="text-sm text-gray-600">For now, variants are handled automatically. Advanced variant options coming soon.</p>

        <!-- Basic variant options -->
        <div>
          <%= render 'variants_form', form: form %>
        </div>
      </div>

      <!-- SEO Section -->
      <div class="py-4 px-6 bg-gray-50 rounded-lg flex flex-col gap-5">
        <h3 class="text-lg font-medium text-gray-900 nata-sans">Search Engine Listing</h3>

        <div>
          <%= form.label :seo_title, "Page Title", class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.text_field :seo_title,
                                value: @product ? @product.dig('seo', 'title') : '',
                                maxlength: 70,
                                class: "w-full p-2 border rounded text-sm nata-sans" %>
          </div>
          <p class="mt-1 text-xs text-gray-500">0 of 70 characters used</p>
        </div>

        <div>
          <%= form.label :seo_description, "Meta Description", class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.text_area :seo_description,
                               value: @product ? @product.dig('seo', 'description') : '',
                               rows: 3,
                               maxlength: 320,
                               class: "w-full p-2 border rounded text-sm nata-sans" %>
          </div>
          <p class="mt-1 text-xs text-gray-500">0 of 320 characters used</p>
        </div>

        <div>
          <%= form.label :seo_url, "URL Handle", class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.text_field :seo_url,
                                value: @product ? @product.dig('seo', 'url_handle') : '',
                                class: "w-full p-2 border rounded text-sm nata-sans" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="w-1/4 space-y-5">
      <!-- Status -->
      <div class="py-4 px-6 bg-gray-50 rounded-lg flex flex-col gap-5">
        <div>
          <%= form.label :status, class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.select :status,
                            options_for_select([
                                                 ['Active', 'active'],
                                                 ['Draft', 'draft'],
                                                 ['Archived', 'archived']
                                               ], @product ? @product['status'] : 'active'),
                            {},
                            { class: "w-full p-2 border rounded text-sm nata-sans" } %>
          </div>
        </div>
      </div>

      <!-- Product Organization -->
      <div class="py-4 px-6 bg-gray-50 rounded-lg flex flex-col gap-5">
        <h3 class="text-lg font-medium text-gray-900 nata-sans">Organization</h3>

        <div>
          <%= form.label :product_type, "Product Type", class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.text_field :product_type,
                                value: @product ? @product.dig('organization', 'product_type') : '',
                                class: "w-full p-2 border rounded text-sm nata-sans" %>
          </div>
        </div>

        <div>
          <%= form.label :vendor, "Vendor", class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.text_field :vendor,
                                value: @product ? @product.dig('organization', 'vendor') : '',
                                class: "w-full p-2 border rounded text-sm nata-sans" %>
          </div>
        </div>

        <div>
          <%= form.label :tags, "Tags", class: "block text-sm font-medium text-gray-700 nata-sans" %>
          <div class="mt-1">
            <%= form.text_field :tags,
                                value: @product ? (@product.dig('organization', 'tags') || []).join(', ') : '',
                                placeholder: "vintage, cotton, summer",
                                class: "w-full p-2 border rounded text-sm nata-sans" %>
          </div>
          <p class="mt-1 text-xs text-gray-500">Separate tags with commas</p>
        </div>

      </div>

      <div class="flex justify-end space-x-3 mt-6">
        <%= form.submit submit_text,
                        class: "w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 nata-sans" %>
      </div>
    </div>
  </div>

<% end %>

<style>
    /* Custom dropdown styling */
    [data-category-dropdown] .relative {
        position: relative;
    }

    [data-category-menu] {
        z-index: 50;
    }

    [data-category-checkbox]:focus {
        ring: 2px;
        ring-color: rgb(59 130 246 / 0.5);
        border-color: rgb(59 130 246);
    }

    /* Indentation classes for hierarchical display */
    .ml-4 { margin-left: 1rem; }
    .ml-8 { margin-left: 2rem; }
    .ml-12 { margin-left: 3rem; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Track quantity checkbox functionality
        const trackQuantityCheckbox = document.getElementById('track_quantity_checkbox');
        const quantityField = document.getElementById('quantity_field');
        const sellOutOfStockField = document.getElementById('sell_out_of_stock_field');

        function toggleQuantityField() {
            if (trackQuantityCheckbox.checked) {
                quantityField.style.display = 'block';
                sellOutOfStockField.style.display = 'flex';
            } else {
                quantityField.style.display = 'none';
                sellOutOfStockField.style.display = 'none';
            }
        }

        // Set initial state
        toggleQuantityField();

        // Add event listener
        trackQuantityCheckbox.addEventListener('change', toggleQuantityField);

        // SKU/Barcode checkbox functionality
        const skuBarcodeCheckbox = document.getElementById('has_sku_or_barcode_checkbox');
        const skuBarcodeFields = document.getElementById('sku_barcode_fields');

        function toggleSkuBarcodeFields() {
            if (skuBarcodeCheckbox.checked) {
                skuBarcodeFields.style.display = 'flex';
            } else {
                skuBarcodeFields.style.display = 'none';
            }
        }

        // Set initial state
        toggleSkuBarcodeFields();

        // Add event listener
        skuBarcodeCheckbox.addEventListener('change', toggleSkuBarcodeFields);

        // Physical product checkbox functionality
        const physicalProductCheckbox = document.getElementById('physical_product_checkbox');
        const physicalProductFields = document.getElementById('physical_product_fields');

        function togglePhysicalProductFields() {
            if (physicalProductCheckbox.checked) {
                physicalProductFields.style.display = 'block';
            } else {
                physicalProductFields.style.display = 'none';
            }
        }

        // Set initial state
        togglePhysicalProductFields();

        // Add event listener
        physicalProductCheckbox.addEventListener('change', togglePhysicalProductFields);
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initProductCategoryDropdown();
    });

    function initProductCategoryDropdown() {
        const dropdown = document.querySelector('[data-category-dropdown]');
        if (!dropdown) return;

        const trigger = dropdown.querySelector('[data-category-trigger]');
        const menu = dropdown.querySelector('[data-category-menu]');
        const placeholder = dropdown.querySelector('[data-category-placeholder]');
        const hiddenInput = document.querySelector('[data-categories-hidden]');
        const checkboxes = dropdown.querySelectorAll('[data-category-checkbox]');
        const categoryPreview = document.querySelector('[data-category-preview]');

        if (!trigger || !menu || !placeholder || !hiddenInput) return;

        // Toggle dropdown
        trigger.addEventListener('click', function(e) {
            e.preventDefault();
            menu.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // Handle checkbox changes
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCategories();
            });
        });

        function updateSelectedCategories() {
            const selectedCategories = [];
            const selectedNames = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedCategories.push(checkbox.value);
                    selectedNames.push(checkbox.dataset.categoryName);
                }
            });

            // Update hidden input
            hiddenInput.value = selectedCategories.join(',');

            // Update placeholder text
            if (selectedNames.length === 0) {
                placeholder.textContent = 'Select categories...';
                placeholder.className = 'text-gray-500';
            } else if (selectedNames.length === 1) {
                placeholder.textContent = selectedNames[0];
                placeholder.className = 'text-gray-900';
            } else {
                placeholder.textContent = `${selectedNames.length} categories selected`;
                placeholder.className = 'text-gray-900';
            }

            // Update preview badges
            updateCategoryPreview(selectedNames);
        }

        function updateCategoryPreview(categoryNames) {
            if (!categoryPreview) return;

            if (categoryNames.length > 0) {
                const badges = categoryNames.map(name =>
                    `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-1 mb-1">${name}</span>`
                ).join('');
                categoryPreview.innerHTML = badges;
            } else {
                categoryPreview.innerHTML = '';
            }
        }

        // Initialize on load
        updateSelectedCategories();
    }

    // Handle Turbo events if you're using Hotwire
    document.addEventListener('turbo:load', function() {
        initProductCategoryDropdown();
    });
</script>